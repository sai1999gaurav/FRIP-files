<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMTS Station Infrastructure Dashboard - FRIP</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Leaflet CSS and JS for Map -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }
        
        .header {
            background: linear-gradient(90deg, #1a3a5c 0%, #2d5a87 100%);
            padding: 15px 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left h1 {
            font-size: 1.6rem;
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .header-left p {
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .frip-logo {
            height: 50px;
            background: white;
            padding: 5px 10px;
            border-radius: 5px;
        }
        
        .excel-upload {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .excel-upload label {
            background: #70AD47;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background 0.2s;
        }
        
        .excel-upload label:hover {
            background: #5a9a3a;
        }
        
        .excel-upload input {
            display: none;
        }
        
        .file-status {
            font-size: 0.8rem;
            color: #8ab4f8;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .axis-info {
            background: rgba(68, 114, 196, 0.2);
            border: 1px solid rgba(68, 114, 196, 0.5);
            border-radius: 10px;
            padding: 12px 18px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            font-size: 0.8rem;
            align-items: center;
        }
        
        .axis-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .axis-item .label {
            background: #4472C4;
            padding: 3px 10px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.75rem;
        }
        
        .axis-item span:not(.label) {
            font-size: 0.78rem;
        }
        
        /* View Toggle Styles */
        .view-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .toggle-container {
            display: flex;
            background: rgba(255,255,255,0.1);
            border-radius: 25px;
            padding: 4px;
        }
        
        .toggle-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s;
            background: transparent;
            color: #aaa;
        }
        
        .toggle-btn.active {
            background: #4472C4;
            color: white;
        }
        
        .toggle-btn:hover:not(.active) {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }
        
        .filters-section {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px 20px;
        }
        
        .filter-group.cluster-group {
            flex: 0 0 65%;
            min-width: 500px;
        }
        
        .filter-group.route-group {
            flex: 0 0 30%;
            min-width: 250px;
        }
        
        .filter-group h3 {
            font-size: 0.85rem;
            margin-bottom: 12px;
            color: #8ab4f8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .filter-btn {
            padding: 6px 14px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
            background: rgba(255,255,255,0.1);
            color: #ccc;
        }
        
        .filter-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .filter-btn.active {
            background: #4472C4;
            color: white;
        }
        
        .filter-btn.cluster-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px 12px;
            font-size: 0.75rem;
        }
        
        .filter-btn.cluster-btn .cluster-code {
            font-weight: 700;
            font-size: 0.8rem;
        }
        
        .filter-btn.cluster-btn .cluster-name {
            font-size: 0.7rem;
            opacity: 0.9;
        }
        
        .filter-btn.cluster-btn.active {
            background: #4472C4 !important;
        }
        
        .main-content {
            display: flex;
            gap: 20px;
        }
        
        .chart-container {
            flex: 1;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            position: relative;
        }
        
        .chart-wrapper {
            position: relative;
            height: 600px;
        }
        
        #bubbleChart {
            width: 100% !important;
            height: 100% !important;
        }
        
        /* Map Container */
        #mapContainer {
            width: 100%;
            height: 600px;
            border-radius: 10px;
            display: none;
        }
        
        .quadrant-labels {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }
        
        .quadrant-label {
            position: absolute;
            font-size: 0.75rem;
            color: rgba(255,255,255,0.4);
            padding: 5px 10px;
            border-radius: 4px;
            background: rgba(0,0,0,0.3);
        }
        
        .q-top-right { top: 60px; right: 60px; }
        .q-top-left { top: 60px; left: 80px; }
        .q-bottom-right { bottom: 60px; right: 60px; }
        .q-bottom-left { bottom: 60px; left: 80px; }
        
        .sidebar {
            width: 320px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .stats-card, .legend-card, .top-stations {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
        }
        
        .stats-card h3, .legend-card h3, .top-stations h3 {
            font-size: 0.9rem;
            color: #8ab4f8;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #8ab4f8;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: #888;
            margin-top: 5px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            cursor: pointer;
            transition: background 0.2s;
            border-radius: 5px;
            padding-left: 5px;
        }
        
        .legend-item:hover {
            background: rgba(255,255,255,0.05);
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }
        
        .legend-count {
            margin-left: auto;
            background: rgba(255,255,255,0.1);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }
        
        .legend-separator {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 8px 0;
        }
        
        .station-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .station-score {
            color: #8ab4f8;
            font-weight: 600;
        }
        
        .metro-badge {
            background: #7030A0;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.65rem;
            margin-left: 5px;
            vertical-align: middle;
        }
        
        #tooltip {
            position: fixed;
            background: rgba(20, 25, 45, 0.98);
            border: 1px solid rgba(68, 114, 196, 0.5);
            border-radius: 10px;
            padding: 15px;
            pointer-events: none;
            z-index: 1000;
            display: none;
            min-width: 200px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        .tooltip-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tooltip-cluster {
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 4px;
            margin-bottom: 10px;
            display: inline-block;
        }
        
        .tooltip-metrics {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .tooltip-metric {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
        }
        
        .tooltip-metric span:first-child {
            color: #888;
        }
        
        #loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        #loading.show {
            display: flex;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #333;
            border-top-color: #4472C4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Leaflet popup styling */
        .leaflet-popup-content-wrapper {
            background: rgba(20, 25, 45, 0.98);
            border: 1px solid rgba(68, 114, 196, 0.5);
            border-radius: 10px;
            color: #fff;
        }
        
        .leaflet-popup-tip {
            background: rgba(20, 25, 45, 0.98);
        }
        
        .map-popup-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .map-popup-cluster {
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 4px;
            margin-bottom: 10px;
            display: inline-block;
        }
        
        .map-popup-metrics {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .map-popup-metric {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
        }
        
        .map-popup-metric span:first-child {
            color: #aaa;
        }
    </style>
</head>
<body>
    <div id="tooltip"></div>
    <div id="loading"><div class="spinner"></div></div>
    
    <div class="header">
        <div class="header-left">
            <h1>MMTS Station Infrastructure Dashboard</h1>
            <p>Last Mile Connectivity & Road Access Analysis</p>
        </div>
        <div class="header-right">
            <div class="excel-upload">
                <label for="excel-file">üìÅ Load Excel</label>
                <input type="file" id="excel-file" accept=".xlsx,.xls">
                <span class="file-status" id="file-status">No file loaded</span>
            </div>
            <img src="data:image/webp;base64,UklGRuwGAABXRUJQVlA4WAoAAAAgAAAArwAAcgAASUNDUMgBAAAAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADZWUDgg/gQAAPAeAJ0BKrAAcwA+USCPRSOhoZKYlnw4BQSxgGpCTrbbzLktx2HaPLvnf/yPrL27POw6eBTq/WPq010H+L/FDza6gr/F/9b4QX67Wg2inNgNZsaY4A0PoSZ3lYjtgGLcPfCmRB0bqhZ2rfZZ+SIwkshL8poVAwsrL/mVyr3BSTwZtpBbBdegSRthpXVl+6jYCx5hik2WPZO2Ev5IveyXVsipASwYwjaheCmMFHw3J5R8bpmyh1aoR7V9ygh4eOqPHxOTVzME2p7wxHdfOoN4kRk7QuC9c/ChE0RGcNSmwxl+uz6PietkrQP+omiV1d5CrlMKvubvAwaqH28Vm/gg+AAA/v3AgAAUcL5f5/s4BbbD+o/++DcRJCoT+SeaJpu3fZevqTtqypjknCckZjq8NAoLcidt//iZBLJ5q2uOrVH8HsZN4TzrKAy9Ep4mP71Swl+nH7UU7pVQcmcJga2lH4vMdCzhToMg59pX965neBBbq+p6gNkU/ylddFPPdqDgj96Z1whsToFTI5L919PkC/PIVliREY8VkTfP/o1LAv6+k8rw12UsW6qyipo/gjRhv+IEhYLIHe3UjZrnExE+pODulVE7ZtADY7kkKn/C9I5sma3IVfCsSTQ/d1cpQp/85cf/K9NbIN0TIrQ/d21l/4NRz9CdXyJmygWP1KrC6hBD+Q6YhkfKqcYgrHBxFuX+HPnus86UOfYeUnWrjr/wvWpmPGiQlprsMRgAYPf2sOjVArIcvVf8NfszV32AABh8DRa34r2XPHpALDVJgdwCgz7wxh5jDzDFTmJ6ogf5HbbUB6kpmlhBumhKcJMX6dXApHnzZU9XlkM5fpRUyikDTSfhDhtD6X+BMmdYU1DsVqjJ0SQ83NLH6P1Cm3PTf5w/yMsP72/ee/ykYbkxRffc5vFVprLdFA2b8Isz4IAfmx2PcWEF7h0qRMQDQ2ZiIm5dRdWIO0rkh1bdIZBZAG9x3UDS5mGaQ8atEvX0PeLvvZr4fnCjmm4Q8FjaV8h45+xLTgs1B01woPtaVL6lhpYVAlNbYuGrxKT1OwaqfsiG8Ki2KZv2SFhlJomiuFIZ4zjHnW7epXrcD39uCRa5tb5DY5/TYJINssHQg85wZNxJJMMs5Ze8Ad/4x/yR/y+iQR7rJAh/HVj71RHTsV2w8f88GO/pNxJPAJwHBY8CCfgNKF5Ty+B9iwjfFtFUccEVcr9e2qT28FPvTRPOoImGY2sidnFH87Dfj4ZikYqEfpGQzR9JuBQuRfo3UvD73zxbXFV6GvtOA9dyD8y5PjyJ5nD7Qcac6QXMaXIkI4z4rDEQYgfB8gaS37E86v4GF+63+hlV0OfsJHE9vkGricsZPMGjszr7wp/mFHFZFY//4tB7/7I5LR4TE2WqlUIYN9SP3pYQkQbjJEFW8hHwJHJ9j2cJj2q4WIB0saMYXIIwPwjN1NATZ5bB4CxADsgxrudj9+Leh+tl5xXCRU/JT/7v0/EDRifNZoKB9BikrdxJLSp0WpfjcwHeV79H7e9ceQZvy0zfMTfyEQH43/aGwr5QQDEfoVVUl8iuaFGGlx9Wo40dIXMxTIyzohavFEJJngr0FB/tsDKA+JOW8TZFYIcoWb+fKeZr1Sp8VW2pBIbGDkdBImdTdncy8DG6TRn1vzXwCdCjxLo6MlpIILot4FXWwTM9DZxolyM9wrdBStQAAAAAAA==" alt="FRIP Logo" class="frip-logo">
        </div>
    </div>
    
    <div class="container">
        <div class="axis-info">
            <!-- View Toggle - moved to left -->
            <div class="view-toggle">
                <span style="color: #8ab4f8; font-size: 0.78rem;">View:</span>
                <div class="toggle-container">
                    <button class="toggle-btn active" id="graphToggle" onclick="switchView('graph')">üìä Graph</button>
                    <button class="toggle-btn" id="mapToggle" onclick="switchView('map')">üó∫Ô∏è Map</button>
                </div>
            </div>
            <div class="axis-item">
                <span class="label">X-Axis</span>
                <span>Road Connectivity Index (1-5)</span>
            </div>
            <div class="axis-item">
                <span class="label">Y-Axis</span>
                <span>Last Mile Index (1-5)</span>
            </div>
            <div class="axis-item">
                <span class="label">Bubble Size</span>
                <span>Infrastructure Index</span>
            </div>
            <div class="axis-item">
                <span class="label">Filled Bubbles</span>
                <span>Metro Connected Stations</span>
            </div>
        </div>
        
        <div class="filters-section">
            <div class="filter-group cluster-group">
                <h3>Filter by Cluster</h3>
                <div class="filter-buttons" id="cluster-filters"></div>
            </div>
            <div class="filter-group route-group">
                <h3>Filter by Route</h3>
                <div class="filter-buttons" id="route-filters"></div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="chart-container">
                <div class="chart-wrapper" id="chartWrapper">
                    <canvas id="bubbleChart"></canvas>
                    <div class="quadrant-labels" id="quadrantLabels">
                        <div class="quadrant-label q-top-right">Well Connected</div>
                        <div class="quadrant-label q-top-left">Road Priority</div>
                        <div class="quadrant-label q-bottom-right">Last-Mile Priority</div>
                        <div class="quadrant-label q-bottom-left">Comprehensive Need</div>
                    </div>
                </div>
                <div id="mapContainer"></div>
            </div>
            
            <div class="sidebar">
                <div class="stats-card">
                    <h3>Current Selection</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="stat-stations">51</div>
                            <div class="stat-label">Stations</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="stat-metro">7</div>
                            <div class="stat-label">Metro Connected</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="stat-avg-road">3.0</div>
                            <div class="stat-label">Road Connectivity Index</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="stat-avg-lm">3.4</div>
                            <div class="stat-label">Last Mile Index</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="stat-avg-infra">3.8</div>
                            <div class="stat-label">Infrastructure Index</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Station coordinates mapping (from OpenStreetMap data)
        // Maps station names used in Excel to [lat, lon] coordinates
        const stationCoordinates = {
            // Exact matches
            "Alwal": [17.5050368, 78.514663],
            "Ammuguda": [17.4863882, 78.5271469],
            "Arts College": [17.417977, 78.5200383],
            "BHEL": [17.5022187, 78.2823111],
            "Begumpet": [17.4386951, 78.4580969],
            "Bolarum": [17.5330679, 78.5154568],
            "Charlapalli": [17.4585975, 78.6066056],
            "Falaknuma": [17.3326604, 78.4751984],
            "Hafeezpet": [17.4823997, 78.3630141],
            "Kacheguda": [17.389311, 78.4992403],
            "Khairatabad": [17.4375661, 78.4569341],
            "Lingampalli": [17.4831225, 78.3177732],
            "Malakpet": [17.3765035, 78.4948263],
            "Malkajgiri": [17.4483438, 78.5289727],
            "Neredmet": [17.4781112, 78.5366716],
            "Safilguda": [17.46162, 78.5331229],
            "Secunderabad Junction": [17.4338591, 78.502051],
            "Sitafalmandi": [17.4272947, 78.5207231],
            "Telapur": [17.4749602, 78.2849764],
            "Umdanagar": [17.2634072, 78.3931714],
            "Vidyanagar": [17.4018362, 78.5108121],
            
            // Name variations - Excel name: [lat, lon]
            "Hitech City": [17.4698143, 78.3853779],
            "Hi-Tech City": [17.4698143, 78.3853779],
            "HiTech City": [17.4698143, 78.3853779],
            
            "Chanda Nagar": [17.4872976, 78.3322142],
            "Chandanagar": [17.4872976, 78.3322142],
            
            "Bharatnagar": [17.4626026, 78.4301562],
            "Bharath Nagar": [17.4626026, 78.4301562],
            
            "Lakdikapul": [17.4038328, 78.4635019],
            "Lakdi-ka-pul": [17.4038328, 78.4635019],
            "Lakdi Ka Pul": [17.4038328, 78.4635019],
            
            "Nampally": [17.3924223, 78.4675956],
            "Hyderabad Deccan Nampally": [17.3924223, 78.4675956],
            "Hyderabad Deccan": [17.3924223, 78.4675956],
            
            "Lalaguda": [17.4408124, 78.5247765],
            "Lalaguda Gate": [17.4408124, 78.5247765],
            
            "Dayanand Nagar": [17.4559393, 78.5314333],
            
            "Ramakistapuram": [17.4763716, 78.5290898],
            "Ramakistapuram Gate": [17.4763716, 78.5290898],
            
            "Cavalry Barracks": [17.4953503, 78.519068],
            
            "Bolarum Bazar": [17.5176302, 78.5156805],
            "Bolarum Bazaar": [17.5176302, 78.5156805],
            
            "Gundla Pochampally": [17.5687096, 78.4882373],
            
            "Gowdavalli": [17.6033, 78.4810], // Corrected - on railway track between G.Pochampally & Medchal
            
            "Medchal": [17.63993, 78.47534], // Corrected OSM node 2962282515
            
            "Moula Ali": [17.4407394, 78.5506697],
            "Moula Ali HB Colony": [17.4415, 78.5520], // Close to Moula Ali
            "Moula Ali HB": [17.4415, 78.5520],
            
            "Ammuguda New": [17.4870, 78.5275], // Slightly different location
            
            "Bhudevi Nagar": [17.4929657, 78.5021679],
            
            "Suchitra Centre": [17.4892259, 78.4729062],
            "Suchitra": [17.4892259, 78.4729062],
            
            "Ferozguda": [17.4648917, 78.4603057],
            
            "Jamai Osmania": [17.4116226, 78.5181614],
            
            "Dabirpura": [17.3665277, 78.4901244],
            
            "Yakatpura": [17.3600834, 78.4921942],
            "Yakutpura": [17.3600834, 78.4921942],
            
            "Huppuguda": [17.3415227, 78.4825047],
            
            "NPA Shivarampalli": [17.3230489, 78.436567],
            "NPA Shivaram Pally": [17.3230489, 78.436567],
            "Shivarampalli": [17.3230489, 78.436567],
            
            "Budvel": [17.3098599, 78.4249837],
            
            "Ramachandrapuram": [17.5102204, 78.2824464],
            "Ramachandrapuram TS": [17.5102204, 78.2824464],
            
            "James Street": [17.4329515, 78.4873218],
            
            "Sanjeevaiah Park": [17.4356998, 78.4764022],
            
            "Nature Cure Hospital": [17.4456571, 78.4521487],
            
            "Fateh Nagar": [17.4562011, 78.4499241],
            
            "Borabanda": [17.4590687, 78.4078664],
            
            "Sanat Nagar": [17.4622355, 78.4366978],
            "Sanath Nagar": [17.4622355, 78.4366978],
            
            "Nagalapalli": [17.460242, 78.2300829],
            
            "Necklace Road": [17.4233355, 78.4631857],
            
            "Shah Ali Banda": [17.3539755, 78.4728875],
            "Shah Ali Banda Metro Station": [17.3539755, 78.4728875]
        };
        
        // Cluster colors with full names as keys
        const clusterColors = {
            "Cluster 1A: Well Connected (Metro)": "#70AD47",
            "Cluster 1B: Well Connected (Non-Metro)": "#70AD47",
            "Cluster 1C: Well Connected (Poor Infra)": "#70AD47",
            "Cluster 2: Last-Mile Priority": "#7030A0",
            "Cluster 3A: Approach Road Deficit": "#FFC000",
            "Cluster 3B: Approach Road Deficit (Poor Infra)": "#FFC000",
            "Cluster 4A: Infrastructure Desert": "#C00000",
            "Cluster 4B: Infrastructure Desert (Poor Infra)": "#C00000"
        };

        // Default station data (will be replaced when Excel is loaded)
        let stationsData = [
            {"station":"Hitech City","route":"Lingampalli-Hitech-Begumpet","cluster":"Cluster 2: Last-Mile Priority","road":5.0,"lastMile":3.0,"infra":5.0,"metro":0,"overall":4.54},
            {"station":"Begumpet","route":"Lingampalli-Hitech-Begumpet","cluster":"Cluster 1A: Well Connected (Metro)","road":5.0,"lastMile":3.0,"infra":5.0,"metro":1,"overall":5.38},
            {"station":"Lingampalli","route":"Lingampalli-Hitech-Begumpet","cluster":"Cluster 4A: Infrastructure Desert","road":1.4,"lastMile":2.33,"infra":4.6,"metro":0,"overall":3.23},
            {"station":"Chanda Nagar","route":"Lingampalli-Hitech-Begumpet","cluster":"Cluster 4B: Infrastructure Desert (Poor Infra)","road":1.4,"lastMile":2.33,"infra":3.2,"metro":0,"overall":2.19},
            {"station":"Hafeezpet","route":"Lingampalli-Hitech-Begumpet","cluster":"Cluster 2: Last-Mile Priority","road":4.2,"lastMile":2.33,"infra":4.6,"metro":0,"overall":3.77},
            {"station":"Bharatnagar","route":"Lingampalli-Hitech-Begumpet","cluster":"Cluster 1A: Well Connected (Metro)","road":4.2,"lastMile":5.0,"infra":3.4,"metro":1,"overall":4.46},
            {"station":"Khairatabad","route":"Nampally-Secunderabad Jun","cluster":"Cluster 1A: Well Connected (Metro)","road":4.2,"lastMile":5.0,"infra":3.4,"metro":1,"overall":4.46},
            {"station":"Lakdikapul","route":"Nampally-Secunderabad Jun","cluster":"Cluster 1A: Well Connected (Metro)","road":3.0,"lastMile":5.0,"infra":3.4,"metro":1,"overall":4.23},
            {"station":"Nampally","route":"Nampally-Secunderabad Jun","cluster":"Cluster 1A: Well Connected (Metro)","road":5.0,"lastMile":5.0,"infra":5.0,"metro":1,"overall":6.0},
            {"station":"Secunderabad Junction","route":"Nampally-Secunderabad Jun","cluster":"Cluster 1A: Well Connected (Metro)","road":5.0,"lastMile":5.0,"infra":5.0,"metro":1,"overall":6.0},
            {"station":"Malkajgiri","route":"Sec-Malkajgiri-Medchal","cluster":"Cluster 3A: Approach Road Deficit","road":1.0,"lastMile":4.33,"infra":5.0,"metro":0,"overall":4.08},
            {"station":"Malakpet","route":"Falaknuma-Kacheguda-Sec","cluster":"Cluster 1A: Well Connected (Metro)","road":4.2,"lastMile":4.33,"infra":4.2,"metro":1,"overall":4.77},
            {"station":"Umdanagar","route":"Umdanagar-Falaknuma","cluster":"Cluster 4A: Infrastructure Desert","road":1.0,"lastMile":3.67,"infra":4.2,"metro":0,"overall":3.0},
            {"station":"Falaknuma","route":"Falaknuma-Kacheguda-Sec","cluster":"Cluster 4A: Infrastructure Desert","road":1.0,"lastMile":2.33,"infra":4.2,"metro":0,"overall":2.69},
            {"station":"Kacheguda","route":"Falaknuma-Kacheguda-Sec","cluster":"Cluster 1B: Well Connected (Non-Metro)","road":5.0,"lastMile":5.0,"infra":5.0,"metro":0,"overall":5.0},
            {"station":"Charlapalli","route":"Moula Ali-Shadnagar","cluster":"Cluster 3A: Approach Road Deficit","road":1.0,"lastMile":5.0,"infra":5.0,"metro":0,"overall":4.23},
            {"station":"Moula Ali","route":"Moula Ali-Shadnagar","cluster":"Cluster 4A: Infrastructure Desert","road":1.0,"lastMile":2.33,"infra":4.2,"metro":0,"overall":2.69},
            {"station":"Alwal","route":"Sec-Malkajgiri-Medchal","cluster":"Cluster 4A: Infrastructure Desert","road":1.0,"lastMile":3.0,"infra":4.2,"metro":0,"overall":2.85},
            {"station":"Sitafalmandi","route":"Falaknuma-Kacheguda-Sec","cluster":"Cluster 3A: Approach Road Deficit","road":1.0,"lastMile":3.67,"infra":5.0,"metro":0,"overall":3.92},
            {"station":"Lalaguda","route":"Sec-Malkajgiri-Medchal","cluster":"Cluster 1C: Well Connected (Poor Infra)","road":5.0,"lastMile":4.33,"infra":1.8,"metro":0,"overall":2.54},
            {"station":"Dayanand Nagar","route":"Sec-Malkajgiri-Medchal","cluster":"Cluster 3B: Approach Road Deficit (Poor Infra)","road":1.8,"lastMile":4.33,"infra":1.8,"metro":0,"overall":1.92},
            {"station":"Safilguda","route":"Sec-Malkajgiri-Medchal","cluster":"Cluster 1B: Well Connected (Non-Metro)","road":5.0,"lastMile":5.0,"infra":4.2,"metro":0,"overall":4.08},
            {"station":"Ramakistapuram","route":"Sec-Malkajgiri-Medchal","cluster":"Cluster 4B: Infrastructure Desert (Poor Infra)","road":1.0,"lastMile":3.67,"infra":3.4,"metro":0,"overall":2.54},
            {"station":"Ammuguda","route":"Sec-Malkajgiri-Medchal","cluster":"Cluster 4B: Infrastructure Desert (Poor Infra)","road":1.8,"lastMile":1.67,"infra":1.8,"metro":0,"overall":1.31},
            {"station":"Cavalry Barracks","route":"Sec-Malkajgiri-Medchal","cluster":"Cluster 4A: Infrastructure Desert","road":1.0,"lastMile":3.0,"infra":4.0,"metro":0,"overall":2.73},
            {"station":"Bolarum Bazar","route":"Sec-Malkajgiri-Medchal","cluster":"Cluster 3B: Approach Road Deficit (Poor Infra)","road":1.8,"lastMile":4.33,"infra":2.4,"metro":0,"overall":2.27},
            {"station":"Bolarum","route":"Sec-Malkajgiri-Medchal","cluster":"Cluster 2: Last-Mile Priority","road":5.0,"lastMile":1.67,"infra":4.2,"metro":0,"overall":3.31},
            {"station":"Gundla Pochampally","route":"Sec-Malkajgiri-Medchal","cluster":"Cluster 4A: Infrastructure Desert","road":1.0,"lastMile":1.67,"infra":4.2,"metro":0,"overall":2.54},
            {"station":"Gowdavalli","route":"Sec-Malkajgiri-Medchal","cluster":"Cluster 4B: Infrastructure Desert (Poor Infra)","road":1.8,"lastMile":1.67,"infra":1.8,"metro":0,"overall":1.31},
            {"station":"Medchal","route":"Sec-Malkajgiri-Medchal","cluster":"Cluster 2: Last-Mile Priority","road":4.2,"lastMile":2.33,"infra":5.0,"metro":0,"overall":4.23},
            {"station":"Moula Ali HB Colony","route":"Moula Ali-Shadnagar","cluster":"Cluster 4B: Infrastructure Desert (Poor Infra)","road":1.8,"lastMile":1.33,"infra":3.4,"metro":0,"overall":2.15},
            {"station":"Neredmet","route":"Moula Ali-Shadnagar","cluster":"Cluster 1C: Well Connected (Poor Infra)","road":5.0,"lastMile":5.0,"infra":3.4,"metro":0,"overall":3.62},
            {"station":"Ammuguda New","route":"Moula Ali-Shadnagar","cluster":"Cluster 4A: Infrastructure Desert","road":1.8,"lastMile":1.67,"infra":4.2,"metro":0,"overall":2.69},
            {"station":"Bhudevi Nagar","route":"Moula Ali-Shadnagar","cluster":"Cluster 4B: Infrastructure Desert (Poor Infra)","road":1.0,"lastMile":3.0,"infra":1.8,"metro":0,"overall":1.46},
            {"station":"Suchitra Centre","route":"Moula Ali-Shadnagar","cluster":"Cluster 1C: Well Connected (Poor Infra)","road":5.0,"lastMile":4.33,"infra":3.4,"metro":0,"overall":3.46},
            {"station":"Ferozguda","route":"Moula Ali-Shadnagar","cluster":"Cluster 1C: Well Connected (Poor Infra)","road":4.2,"lastMile":4.33,"infra":3.4,"metro":0,"overall":3.31},
            {"station":"Arts College","route":"Falaknuma-Kacheguda-Sec","cluster":"Cluster 1B: Well Connected (Non-Metro)","road":5.0,"lastMile":5.0,"infra":4.2,"metro":0,"overall":4.08},
            {"station":"Jamai Osmania","route":"Falaknuma-Kacheguda-Sec","cluster":"Cluster 1C: Well Connected (Poor Infra)","road":5.0,"lastMile":5.0,"infra":2.6,"metro":0,"overall":3.15},
            {"station":"Vidyanagar","route":"Falaknuma-Kacheguda-Sec","cluster":"Cluster 1B: Well Connected (Non-Metro)","road":5.0,"lastMile":5.0,"infra":4.2,"metro":0,"overall":4.08},
            {"station":"Dabirpura","route":"Falaknuma-Kacheguda-Sec","cluster":"Cluster 1C: Well Connected (Poor Infra)","road":4.2,"lastMile":3.67,"infra":2.6,"metro":0,"overall":3.15},
            {"station":"Yakatpura","route":"Falaknuma-Kacheguda-Sec","cluster":"Cluster 2: Last-Mile Priority","road":5.0,"lastMile":2.33,"infra":4.2,"metro":0,"overall":3.46},
            {"station":"Huppuguda","route":"Falaknuma-Kacheguda-Sec","cluster":"Cluster 4A: Infrastructure Desert","road":1.0,"lastMile":2.33,"infra":5.0,"metro":0,"overall":3.62},
            {"station":"NPA Shivarampalli","route":"Umdanagar-Falaknuma","cluster":"Cluster 4B: Infrastructure Desert (Poor Infra)","road":1.0,"lastMile":2.33,"infra":2.6,"metro":0,"overall":1.77},
            {"station":"Budvel","route":"Umdanagar-Falaknuma","cluster":"Cluster 1C: Well Connected (Poor Infra)","road":4.2,"lastMile":3.67,"infra":2.6,"metro":0,"overall":3.15},
            {"station":"Telapur","route":"Lingampalli-Ramachandrapuram","cluster":"Cluster 4B: Infrastructure Desert (Poor Infra)","road":1.8,"lastMile":1.0,"infra":2.4,"metro":0,"overall":1.5},
            {"station":"Ramachandrapuram","route":"Lingampalli-Ramachandrapuram","cluster":"Cluster 2: Last-Mile Priority","road":5.0,"lastMile":1.0,"infra":2.4,"metro":0,"overall":2.12},
            {"station":"James Street","route":"Nampally-Secunderabad Jun","cluster":"Cluster 1C: Well Connected (Poor Infra)","road":5.0,"lastMile":5.0,"infra":2.6,"metro":0,"overall":3.15},
            {"station":"Sanjeevaiah Park","route":"Nampally-Secunderabad Jun","cluster":"Cluster 2: Last-Mile Priority","road":5.0,"lastMile":2.33,"infra":4.2,"metro":0,"overall":3.46},
            {"station":"Nature Cure Hospital","route":"Lingampalli-Hitech-Begumpet","cluster":"Cluster 4B: Infrastructure Desert (Poor Infra)","road":1.8,"lastMile":2.33,"infra":2.6,"metro":0,"overall":1.92},
            {"station":"Fateh Nagar","route":"Lingampalli-Hitech-Begumpet","cluster":"Cluster 3B: Approach Road Deficit (Poor Infra)","road":1.0,"lastMile":3.67,"infra":2.6,"metro":0,"overall":2.08},
            {"station":"Borabanda","route":"Lingampalli-Hitech-Begumpet","cluster":"Cluster 4B: Infrastructure Desert (Poor Infra)","road":1.0,"lastMile":1.67,"infra":2.6,"metro":0,"overall":1.62}
        ];

        // State
        let selectedClusters = new Set();
        let selectedRoutes = new Set();
        let chart = null;
        let map = null;
        let mapMarkers = [];
        let currentView = 'graph';

        // Get station coordinates with fuzzy matching
        function getStationCoords(stationName) {
            // Direct match
            if (stationCoordinates[stationName]) {
                return stationCoordinates[stationName];
            }
            
            // Normalize and try again
            const normalized = stationName.trim();
            if (stationCoordinates[normalized]) {
                return stationCoordinates[normalized];
            }
            
            // Try common variations
            const variations = [
                stationName.replace(/\s+/g, ' '),
                stationName.replace(/-/g, ' '),
                stationName.replace(/\s+/g, '-'),
            ];
            
            for (const variant of variations) {
                if (stationCoordinates[variant]) {
                    return stationCoordinates[variant];
                }
            }
            
            // Case-insensitive search
            const lowerName = stationName.toLowerCase();
            for (const [key, coords] of Object.entries(stationCoordinates)) {
                if (key.toLowerCase() === lowerName) {
                    return coords;
                }
            }
            
            console.warn(`No coordinates found for station: ${stationName}`);
            return null;
        }

        // Switch between Graph and Map view
        function switchView(view) {
            currentView = view;
            
            document.getElementById('graphToggle').classList.toggle('active', view === 'graph');
            document.getElementById('mapToggle').classList.toggle('active', view === 'map');
            
            const chartWrapper = document.getElementById('chartWrapper');
            const mapContainer = document.getElementById('mapContainer');
            const quadrantLabels = document.getElementById('quadrantLabels');
            
            if (view === 'graph') {
                chartWrapper.style.display = 'block';
                mapContainer.style.display = 'none';
                quadrantLabels.style.display = 'block';
            } else {
                chartWrapper.style.display = 'none';
                mapContainer.style.display = 'block';
                quadrantLabels.style.display = 'none';
                
                // Initialize or update map
                if (!map) {
                    initMap();
                } else {
                    updateMapMarkers();
                }
            }
        }

        // Initialize Leaflet map
        function initMap() {
            // Center on Hyderabad
            map = L.map('mapContainer').setView([17.395, 78.45], 11);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                minZoom: 9,
                maxZoom: 18,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Add markers for stations
            updateMapMarkers();
            
            // Force a resize after map is shown
            setTimeout(() => {
                map.invalidateSize();
            }, 100);
        }

        // Update map markers based on filtered data
        function updateMapMarkers() {
            if (!map) return;
            
            // Clear existing markers
            mapMarkers.forEach(marker => map.removeLayer(marker));
            mapMarkers = [];
            
            const data = getFilteredData();
            
            data.forEach(station => {
                const coords = getStationCoords(station.station);
                if (!coords) return;
                
                const color = clusterColors[station.cluster] || '#888888';
                const isFilled = station.metro === 1;
                const radius = Math.max(station.infra * 3, 8);
                
                // Create circle marker
                const marker = L.circleMarker([coords[0], coords[1]], {
                    radius: radius,
                    fillColor: color,
                    color: color,
                    weight: isFilled ? 3 : 1,
                    opacity: 1,
                    fillOpacity: isFilled ? 0.9 : 0.5
                });
                
                // Create popup content
                const popupContent = `
                    <div class="map-popup-title">
                        ${station.station}
                        ${station.metro ? '<span class="metro-badge">METRO</span>' : ''}
                    </div>
                    <div class="map-popup-cluster" style="background: ${color}; color: white;">
                        ${station.cluster.replace('Cluster ', '')}
                    </div>
                    <div class="map-popup-metrics">
                        <div class="map-popup-metric"><span>Road Access:</span><span>${station.road.toFixed(1)}</span></div>
                        <div class="map-popup-metric"><span>Last Mile:</span><span>${station.lastMile.toFixed(1)}</span></div>
                        <div class="map-popup-metric"><span>Infra Index:</span><span>${station.infra.toFixed(1)}</span></div>
                    </div>
                    <div style="margin-top: 8px; font-size: 0.75rem; opacity: 0.7;">${station.route}</div>
                `;
                
                marker.bindPopup(popupContent, {
                    maxWidth: 300,
                    className: 'custom-popup'
                });
                
                // Add hover behavior for tooltip
                marker.on('mouseover', function(e) {
                    this.openPopup();
                });
                
                marker.addTo(map);
                mapMarkers.push(marker);
            });
            
            // Fit bounds if we have markers
            if (mapMarkers.length > 0) {
                const group = L.featureGroup(mapMarkers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // Get unique clusters and routes
        function getUniqueClusters() {
            return [...new Set(stationsData.map(s => s.cluster))].sort();
        }
        
        function getUniqueRoutes() {
            return [...new Set(stationsData.map(s => s.route))].sort();
        }

        // Excel file handling
        document.getElementById('excel-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('loading').classList.add('show');
            document.getElementById('file-status').textContent = 'Loading...';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Find Station_Scores sheet
                    const sheetName = workbook.SheetNames.find(n => n.toLowerCase().includes('station')) || workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    
                    // Find header row (looking for "Station" column)
                    let headerRow = -1;
                    let headers = {};
                    
                    for (let i = 0; i < Math.min(10, jsonData.length); i++) {
                        const row = jsonData[i];
                        if (row && row.some(cell => cell && cell.toString().toLowerCase() === 'station')) {
                            headerRow = i;
                            row.forEach((cell, idx) => {
                                if (cell) headers[cell.toString().toLowerCase().trim()] = idx;
                            });
                            break;
                        }
                    }
                    
                    if (headerRow === -1) {
                        throw new Error('Could not find header row with "Station" column');
                    }
                    
                    // Parse data
                    const newData = [];
                    for (let i = headerRow + 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (!row || !row[headers['station']]) continue;
                        
                        const station = {
                            station: row[headers['station']] || '',
                            route: row[headers['route corridor']] || row[headers['route']] || '',
                            cluster: row[headers['final cluster']] || row[headers['cluster']] || '',
                            road: parseFloat(row[headers['road access score']] || row[headers['road']] || 0),
                            lastMile: parseFloat(row[headers['last mile index']] || row[headers['lastmile']] || row[headers['last mile']] || 0),
                            infra: parseFloat(row[headers['infra index']] || row[headers['infra']] || row[headers['infrastructure']] || 0),
                            metro: parseInt(row[headers['metro']] || row[headers['metro connected']] || 0),
                            overall: parseFloat(row[headers['overall score']] || row[headers['overall']] || 0)
                        };
                        
                        if (station.station && station.cluster) {
                            newData.push(station);
                        }
                    }
                    
                    if (newData.length > 0) {
                        stationsData = newData;
                        document.getElementById('file-status').textContent = `Loaded: ${file.name} (${newData.length} stations)`;
                        
                        // Reinitialize everything
                        selectedClusters.clear();
                        selectedRoutes.clear();
                        initFilters();
                        initLegend();
                        
                        if (chart) {
                            chart.destroy();
                        }
                        createChart();
                        updateStats(stationsData);
                        
                        // Update map if visible
                        if (currentView === 'map' && map) {
                            updateMapMarkers();
                        }
                    } else {
                        throw new Error('No valid station data found');
                    }
                } catch (error) {
                    console.error('Error parsing Excel:', error);
                    document.getElementById('file-status').textContent = 'Error: ' + error.message;
                }
                document.getElementById('loading').classList.remove('show');
            };
            reader.readAsArrayBuffer(file);
        });

        function initFilters() {
            const clusterFilters = document.getElementById('cluster-filters');
            const routeFilters = document.getElementById('route-filters');
            
            clusterFilters.innerHTML = '';
            routeFilters.innerHTML = '';
            
            const clusters = getUniqueClusters();
            const routes = getUniqueRoutes();
            
            // Add "All" button for clusters
            const allClusterBtn = document.createElement('button');
            allClusterBtn.className = 'filter-btn all active';
            allClusterBtn.textContent = 'All';
            allClusterBtn.onclick = () => toggleAllClusters();
            clusterFilters.appendChild(allClusterBtn);
            
            clusters.forEach(cluster => {
                const btn = document.createElement('button');
                // Extract cluster code and name for display
                const match = cluster.match(/Cluster\s+(\d+[A-C]?):\s*(.+)/);
                const shortCode = match ? match[1] : cluster;
                const clusterName = match ? match[2] : '';
                btn.className = 'filter-btn cluster-btn';
                btn.innerHTML = `<span class="cluster-code">${shortCode}</span><span class="cluster-name">${clusterName}</span>`;
                btn.style.borderLeft = `4px solid ${clusterColors[cluster] || '#888'}`;
                btn.style.background = `linear-gradient(90deg, ${clusterColors[cluster]}30 0%, rgba(255,255,255,0.1) 100%)`;
                btn.onclick = () => toggleCluster(cluster, btn);
                clusterFilters.appendChild(btn);
            });
            
            // Add "All" button for routes
            const allRouteBtn = document.createElement('button');
            allRouteBtn.className = 'filter-btn all active';
            allRouteBtn.textContent = 'All';
            allRouteBtn.onclick = () => toggleAllRoutes();
            routeFilters.appendChild(allRouteBtn);
            
            routes.forEach(route => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn';
                btn.textContent = route.length > 15 ? route.substring(0, 13) + '...' : route;
                btn.title = route;
                btn.onclick = () => toggleRoute(route, btn);
                routeFilters.appendChild(btn);
            });
        }

        function toggleAllClusters() {
            selectedClusters.clear();
            document.querySelectorAll('#cluster-filters .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('#cluster-filters .filter-btn.all').classList.add('active');
            updateView();
        }

        function toggleAllRoutes() {
            selectedRoutes.clear();
            document.querySelectorAll('#route-filters .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('#route-filters .filter-btn.all').classList.add('active');
            updateView();
        }

        function toggleCluster(cluster, btn) {
            document.querySelector('#cluster-filters .filter-btn.all').classList.remove('active');
            
            if (selectedClusters.has(cluster)) {
                selectedClusters.delete(cluster);
                btn.classList.remove('active');
            } else {
                selectedClusters.add(cluster);
                btn.classList.add('active');
            }
            
            if (selectedClusters.size === 0) {
                document.querySelector('#cluster-filters .filter-btn.all').classList.add('active');
            }
            updateView();
        }

        function toggleRoute(route, btn) {
            document.querySelector('#route-filters .filter-btn.all').classList.remove('active');
            
            if (selectedRoutes.has(route)) {
                selectedRoutes.delete(route);
                btn.classList.remove('active');
            } else {
                selectedRoutes.add(route);
                btn.classList.add('active');
            }
            
            if (selectedRoutes.size === 0) {
                document.querySelector('#route-filters .filter-btn.all').classList.add('active');
            }
            updateView();
        }

        function getFilteredData() {
            return stationsData.filter(s => {
                const clusterMatch = selectedClusters.size === 0 || selectedClusters.has(s.cluster);
                const routeMatch = selectedRoutes.size === 0 || selectedRoutes.has(s.route);
                return clusterMatch && routeMatch;
            });
        }

        // Update both chart and map based on current view
        function updateView() {
            const data = getFilteredData();
            updateStats(data);
            
            if (currentView === 'graph') {
                updateChart();
            } else {
                updateMapMarkers();
            }
        }

        function initLegend() {
            const legend = document.getElementById('cluster-legend');
            if (!legend) return; // Legend removed, skip
            legend.innerHTML = '';
            
            // Count stations per cluster
            const clusterCounts = {};
            stationsData.forEach(s => {
                clusterCounts[s.cluster] = (clusterCounts[s.cluster] || 0) + 1;
            });
            
            // Group by main cluster
            const mainGroups = { "1": [], "2": [], "3": [], "4": [] };
            const clusters = getUniqueClusters();
            
            clusters.forEach(cluster => {
                const match = cluster.match(/Cluster\s+(\d)/);
                if (match && mainGroups[match[1]]) {
                    mainGroups[match[1]].push(cluster);
                }
            });
            
            // Create legend items grouped by main cluster
            Object.entries(mainGroups).forEach(([mainNum, subClusters]) => {
                if (subClusters.length === 0) return;
                
                subClusters.forEach((cluster, idx) => {
                    const match = cluster.match(/Cluster\s+(\d+[A-C]?):\s*(.*)/);
                    const clusterNum = match ? match[1] : cluster;
                    const clusterName = match ? match[2] : '';
                    
                    const item = document.createElement('div');
                    item.className = 'legend-item';
                    item.innerHTML = `
                        <div class="legend-color" style="background: ${clusterColors[cluster] || '#888'}"></div>
                        <span><strong>${clusterNum}</strong>: ${clusterName}</span>
                        <span class="legend-count">${clusterCounts[cluster] || 0}</span>
                    `;
                    item.onclick = () => {
                        const btn = [...document.querySelectorAll('#cluster-filters .filter-btn')].find(b => 
                            b.textContent === clusterNum
                        );
                        if (btn) toggleCluster(cluster, btn);
                    };
                    legend.appendChild(item);
                });
                
                // Add separator between main groups (except after last)
                if (mainNum !== "4") {
                    const separator = document.createElement('div');
                    separator.className = 'legend-separator';
                    legend.appendChild(separator);
                }
            });
        }

        function updateStats(data) {
            document.getElementById('stat-stations').textContent = data.length;
            document.getElementById('stat-metro').textContent = data.filter(s => s.metro === 1).length;
            
            const avgRoad = data.length > 0 ? (data.reduce((a, b) => a + b.road, 0) / data.length).toFixed(1) : '0';
            const avgLM = data.length > 0 ? (data.reduce((a, b) => a + b.lastMile, 0) / data.length).toFixed(1) : '0';
            const avgInfra = data.length > 0 ? (data.reduce((a, b) => a + b.infra, 0) / data.length).toFixed(1) : '0';
            
            document.getElementById('stat-avg-road').textContent = avgRoad;
            document.getElementById('stat-avg-lm').textContent = avgLM;
            document.getElementById('stat-avg-infra').textContent = avgInfra;
        }

        function createChart() {
            const ctx = document.getElementById('bubbleChart').getContext('2d');
            const data = getFilteredData();
            const clusters = getUniqueClusters();
            
            // Group data by cluster for separate series
            const datasets = clusters.map(cluster => {
                const clusterData = data.filter(s => s.cluster === cluster);
                const color = clusterColors[cluster] || '#888888';
                
                return {
                    label: cluster,
                    data: clusterData.map(s => ({
                        x: s.road,
                        y: s.lastMile,
                        r: Math.max(s.infra * 3.5, 6),
                        station: s.station,
                        cluster: s.cluster,
                        metro: s.metro,
                        infra: s.infra,
                        overall: s.overall,
                        route: s.route
                    })),
                    backgroundColor: clusterData.map(s => 
                        s.metro ? color : color + '70'
                    ),
                    borderColor: color,
                    borderWidth: clusterData.map(s => s.metro ? 3 : 1)
                };
            });

            chart = new Chart(ctx, {
                type: 'bubble',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false,
                            external: function(context) {
                                const tooltip = document.getElementById('tooltip');
                                if (context.tooltip.opacity === 0) {
                                    tooltip.style.display = 'none';
                                    return;
                                }
                                
                                const dataPoint = context.tooltip.dataPoints[0].raw;
                                const color = clusterColors[dataPoint.cluster] || '#888';
                                
                                tooltip.innerHTML = `
                                    <div class="tooltip-title">${dataPoint.station}${dataPoint.metro ? '<span class="metro-badge">METRO</span>' : ''}</div>
                                    <div class="tooltip-cluster" style="background: ${color}">${dataPoint.cluster.replace('Cluster ', '')}</div>
                                    <div class="tooltip-metrics">
                                        <div class="tooltip-metric"><span>Road Connectivity:</span><span>${dataPoint.x.toFixed(1)}</span></div>
                                        <div class="tooltip-metric"><span>Last Mile:</span><span>${dataPoint.y.toFixed(1)}</span></div>
                                        <div class="tooltip-metric"><span>Infra Index:</span><span>${dataPoint.infra.toFixed(1)}</span></div>
                                    </div>
                                    <div style="margin-top: 8px; font-size: 0.75rem; opacity: 0.7;">${dataPoint.route}</div>
                                `;
                                
                                const position = context.chart.canvas.getBoundingClientRect();
                                tooltip.style.display = 'block';
                                tooltip.style.left = position.left + context.tooltip.caretX + 10 + 'px';
                                tooltip.style.top = position.top + context.tooltip.caretY + 'px';
                            }
                        }
                    },
                    scales: {
                        x: {
                            min: 0,
                            max: 6,
                            title: {
                                display: true,
                                text: 'Road Connectivity Index ‚Üí',
                                color: '#8ab4f8',
                                font: { size: 14, weight: 'bold' }
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            },
                            ticks: { color: '#888' }
                        },
                        y: {
                            min: 0,
                            max: 6,
                            title: {
                                display: true,
                                text: '‚Üë Last Mile Index',
                                color: '#8ab4f8',
                                font: { size: 14, weight: 'bold' }
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            },
                            ticks: { color: '#888' }
                        }
                    },
                    animation: {
                        duration: 500
                    }
                },
                plugins: [{
                    id: 'quadrantLines',
                    beforeDraw: (chart) => {
                        const ctx = chart.ctx;
                        const xAxis = chart.scales.x;
                        const yAxis = chart.scales.y;
                        
                        ctx.save();
                        ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                        ctx.setLineDash([5, 5]);
                        ctx.lineWidth = 2;
                        
                        // Vertical line at x=3
                        const x3 = xAxis.getPixelForValue(3);
                        ctx.beginPath();
                        ctx.moveTo(x3, yAxis.top);
                        ctx.lineTo(x3, yAxis.bottom);
                        ctx.stroke();
                        
                        // Horizontal line at y=3
                        const y3 = yAxis.getPixelForValue(3);
                        ctx.beginPath();
                        ctx.moveTo(xAxis.left, y3);
                        ctx.lineTo(xAxis.right, y3);
                        ctx.stroke();
                        
                        ctx.restore();
                    }
                }, {
                    id: 'stationLabels',
                    afterDatasetsDraw: (chart) => {
                        const ctx = chart.ctx;
                        const xAxis = chart.scales.x;
                        const yAxis = chart.scales.y;
                        
                        // Collect all data points with their pixel positions
                        const allPoints = [];
                        chart.data.datasets.forEach((dataset, datasetIndex) => {
                            dataset.data.forEach((point, pointIndex) => {
                                const x = xAxis.getPixelForValue(point.x);
                                const y = yAxis.getPixelForValue(point.y);
                                const r = point.r || 6;
                                allPoints.push({
                                    x, y, r,
                                    station: point.station,
                                    dataY: point.y // actual y value for sorting
                                });
                            });
                        });
                        
                        // Sort by y position (higher y value = higher on chart = should be shown for overlaps)
                        allPoints.sort((a, b) => b.dataY - a.dataY);
                        
                        // Track which positions have labels to avoid overlap
                        const labeledPositions = [];
                        
                        ctx.save();
                        ctx.font = 'italic 9px Arial';
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.85)';
                        ctx.textAlign = 'center';
                        
                        allPoints.forEach(point => {
                            const labelY = point.y + point.r + 12;
                            
                            // Check if this position overlaps with existing labels
                            const isOverlapping = labeledPositions.some(pos => {
                                const dx = Math.abs(pos.x - point.x);
                                const dy = Math.abs(pos.y - point.y);
                                return dx < 40 && dy < 25; // Threshold for overlap
                            });
                            
                            if (!isOverlapping) {
                                ctx.fillText(point.station, point.x, labelY);
                                labeledPositions.push({ x: point.x, y: point.y });
                            }
                        });
                        
                        ctx.restore();
                    }
                }]
            });
        }

        function updateChart() {
            const data = getFilteredData();
            const clusters = getUniqueClusters();
            
            if (chart) {
                // Update datasets
                clusters.forEach((cluster, index) => {
                    const clusterData = data.filter(s => s.cluster === cluster);
                    const color = clusterColors[cluster] || '#888888';
                    
                    chart.data.datasets[index].data = clusterData.map(s => ({
                        x: s.road,
                        y: s.lastMile,
                        r: Math.max(s.infra * 3.5, 6),
                        station: s.station,
                        cluster: s.cluster,
                        metro: s.metro,
                        infra: s.infra,
                        overall: s.overall,
                        route: s.route
                    }));
                    chart.data.datasets[index].backgroundColor = clusterData.map(s => 
                        s.metro ? color : color + '70'
                    );
                    chart.data.datasets[index].borderWidth = clusterData.map(s => s.metro ? 3 : 1);
                });
                chart.update();
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initFilters();
            initLegend();
            createChart();
            updateStats(stationsData);
        });
    </script>
</body>
</html>
